<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tauri Node.js Sidecar 测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
        }
        .output {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .status {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .status.running {
            color: #4CAF50;
        }
        .status.stopped {
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tauri Node.js Sidecar 测试</h1>
        
        <div class="card">
            <h2>Node.js Sidecar 服务器</h2>
            <div class="status" id="serverStatus">状态: 未启动</div>
            <div class="controls">
                <input type="number" id="portInput" value="26040" min="1024" max="65535">
                <button id="startServerBtn">启动服务器</button>
                <button id="stopServerBtn">停止所有进程</button>
                <button id="testServerBtn" disabled>测试连接</button>
            </div>
            <div class="output" id="serverOutput">// 服务器输出将显示在这里</div>
        </div>
        
        <div class="card">
            <h2>HTTP 响应</h2>
            <div class="output" id="httpOutput">// HTTP 响应将显示在这里</div>
        </div>
    </div>

    <script>
        // 等待 Tauri API 加载完成
        document.addEventListener('DOMContentLoaded', () => {
            // 检查是否在 Tauri 环境中运行
            if (window.__TAURI__) {
                console.log('Tauri API 已加载');
                initTauriApp();
            } else {
                console.error('此应用需要在 Tauri 环境中运行');
                document.body.innerHTML = '<h1>错误: 此应用需要在 Tauri 环境中运行</h1>';
            }
        });

        function initTauriApp() {
            const { invoke } = window.__TAURI__.core;
            const { listen } = window.__TAURI__.event;
            const { fetch } = window.__TAURI__.http;

            const startServerBtn = document.getElementById('startServerBtn');
            const stopServerBtn = document.getElementById('stopServerBtn');
            const testServerBtn = document.getElementById('testServerBtn');
            const portInput = document.getElementById('portInput');
            const serverStatus = document.getElementById('serverStatus');
            const serverOutput = document.getElementById('serverOutput');
            const httpOutput = document.getElementById('httpOutput');

            let serverRunning = false;
            let currentPort = 26040;

            // 注册事件监听器
            async function setupEventListeners() {
                await listen('node-stdout', (event) => {
                    appendToOutput(serverOutput, `[STDOUT] ${event.payload}`);
                });

                await listen('node-stderr', (event) => {
                    appendToOutput(serverOutput, `[STDERR] ${event.payload}`);
                });

                await listen('node-error', (event) => {
                    appendToOutput(serverOutput, `[ERROR] ${event.payload}`);
                    updateServerStatus(false);
                });

                await listen('node-terminated', (event) => {
                    appendToOutput(serverOutput, `[TERMINATED] 退出代码: ${event.payload}`);
                    updateServerStatus(false);
                });

                await listen('node-server-ready', (event) => {
                    appendToOutput(serverOutput, `[READY] 服务器已在端口 ${event.payload} 上启动`);
                    currentPort = event.payload;
                    updateServerStatus(true);
                });
            }

            // 启动服务器
            startServerBtn.addEventListener('click', async () => {
                const port = parseInt(portInput.value, 10);
                if (isNaN(port) || port < 1024 || port > 65535) {
                    alert('请输入有效的端口号 (1024-65535)');
                    return;
                }

                serverOutput.textContent = ''; // 清空输出
                appendToOutput(serverOutput, `正在启动 Node.js 服务器，端口: ${port}...`);
                
                try {
                    const result = await invoke('start_node_server_sidecar', { port });
                    appendToOutput(serverOutput, result);
                    currentPort = port;
                } catch (error) {
                    appendToOutput(serverOutput, `[ERROR] 启动服务器失败: ${error}`);
                }
            });

            // 停止所有进程
            stopServerBtn.addEventListener('click', async () => {
                try {
                    const result = await invoke('stop_all_processes');
                    appendToOutput(serverOutput, result);
                    updateServerStatus(false);
                } catch (error) {
                    appendToOutput(serverOutput, `[ERROR] 停止进程失败: ${error}`);
                }
            });

            // 测试服务器连接
            testServerBtn.addEventListener('click', async () => {
                try {
                    httpOutput.textContent = '正在连接到服务器...';
                    const response = await fetch(`http://localhost:${currentPort}`);
                    const data = await response.json();
                    httpOutput.textContent = JSON.stringify(data, null, 2);
                } catch (error) {
                    httpOutput.textContent = `连接失败: ${error}`;
                }
            });

            // 更新服务器状态
            function updateServerStatus(running) {
                serverRunning = running;
                if (running) {
                    serverStatus.textContent = `状态: 运行中 (端口: ${currentPort})`;
                    serverStatus.className = 'status running';
                    testServerBtn.disabled = false;
                } else {
                    serverStatus.textContent = '状态: 已停止';
                    serverStatus.className = 'status stopped';
                    testServerBtn.disabled = true;
                }
            }

            // 添加输出到控制台
            function appendToOutput(element, text) {
                element.textContent += text + '\n';
                element.scrollTop = element.scrollHeight;
            }

            // 设置事件监听器
            setupEventListeners();
        }
    </script>
</body>
</html>